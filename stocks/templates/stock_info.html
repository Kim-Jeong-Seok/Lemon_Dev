{% extends 'base.html' %}
{% load static %}
{% block title %}레몬::주식{% endblock title %}
{% block container %}
{% load humanize %}
{% load mathfilters %}
<style>
    .bottom-nav-stock,.bottom-nav-stock a{
      color: #FFD859;
    }
    .act{
    border-bottom:2px solid #31bc8a;
    }
    .title{
    margin-left:20px;
    margin-right:20px;
    padding-bottom:10px;
    padding-top:20px;
    }
    .title_1{
    width:30%;
    margin-top:10px;
    display:inline-block;
    }
    .stock-name{
    display:inline-block;
    font-size:18px;
    font-weight:bold;
    }
    .code{
    display:inline-block;
    color:grey;
    }
    .marketcode{
    display:inline-block;
    color:white;
    background:lightgrey;
    border-radius:10px;
    padding:5px 10px 5px 10px;
    font-size:11px;
    float:right;
    margin-right:10px;
    }
    .curprice{
    font-size:40px;
    font-weight:bold;
    }
    .blue{
    color:#6289e2;
    }
    .red{
    color:#dd4930 !important;
    }
    .pick{
    float:right;
    color:lightgrey;
    }
    .picked{
    color:gold;
    }
    .btn{
    padding:10px 20px 10px 20px;
    width:100%;
    text-align:center;
    color:white;
    background:#31bc8a;
    margin-top:10px;
    border-radius:10px;
    }
    .red_btn{
    background-color:#dd4930 !important;
    }
    input{
    border:none;
    border-bottom:1px solid #f1f1f1;
    width:69%;
    margin-bottom:10px;
    text-align:center;
    }
</style>
{% block nav %}
<div id="nav" style="border-bottom: 1px solid #f1f1f1;">
            <div>
            <div style="text-align:center;">
                <a style="color: #fff;" href="javascript:history.back();"><i class="fa fa-angle-left" style="position: absolute;
    left: 5px;
    padding: 14px 15px;
    top: 0;
    font-size: 25px;
    font-weight: 600;color:black;"></i></a>주식 상세</div>
        </div>
 </div>
{% endblock nav %}
        {% if result %}
        <div class="title">
                <div class="stock-name">{{ result.isuKorAbbrv }} </div>
                <div class="code">{{ result.isuSrtCd }} </div>
            <div class="pick" onclick="pick('{{ result.isuSrtCd }}')"><i class="fas fa-star"></i></div>
            <div class="marketcode"> {{ result.marketcode }}</div>
                <div class="curprice">{{ result.curPrice|intcomma }}원</div>
                <div class="lastprice"> 종가 : {{ result.prevddClsprc|intcomma }}원</div>
            <i class="fas fa-angle-up red"></i>
            <i class="fas fa-angle-down blue"></i>
            <i class="fas fa-minus"></i>
                <div id="howup" style="display:inline-block;"> {{  result.curPrice|sub:result.prevddClsprc|intcomma }}</div><div class="percent" style="display:inline-block">원</div>
                 <div class="percent" style="display:inline-block;">({{ result.curPrice|sub:result.prevddClsprc|div:result.prevddClsprc|mul:100|floatformat:2 }}%)</div>
        </div>
        {% else %}
            상세정보가 없습니다.
        {% endif %}
<table style="background-color:white;height:35px;width: 100%;">
    <tr>
        <td style="width:25%;text-align:center;" onclick="move_page(0)">일</td>
        <td style="width:25%;text-align:center;" onclick="move_page(1)">주</td>
        <td style="width:25%;text-align:center;" onclick="move_page(2)">월</td>
        <td style="width:25%;text-align:center;" onclick="move_page(3)">년</td>
    </tr>
</table>
<div class="swiper">
    <div class="swiper-scrollbar" style="top:0px;height:3px;"></div>
    <div class="swiper-wrapper">
        <div class="swiper-slide">
              <div class="myChartDiv">
              <canvas id="myChart" width="600" height="400"></canvas>
            </div>
        </div>
        <div class="swiper-slide">
             <div class="myChartDiv">
              <canvas id="myChart1" width="600" height="400"></canvas>
            </div>
        </div>
        <div class="swiper-slide">
             <div class="myChartDiv">
              <canvas id="myChart2" width="600" height="400"></canvas>
            </div>
        </div>
        <div class="swiper-slide">
             <div class="myChartDiv">
              <canvas id="myChart3" width="600" height="400"></canvas>
            </div>
        </div>
    </div>
</div>
<!--<div>-->
<!--    여기에 차트 나오기(양이 많을 때가 있어 console에서 확인)<br/>-->
<!--    <button onclick="get_history('{{result.marketcode}}', '{{result.isuSrtCd}}', 'D')">일봉</button>-->
<!--    <button onclick="get_history('{{result.marketcode}}', '{{result.isuSrtCd}}', 'W')">주봉</button>-->
<!--    <button onclick="get_history('{{result.marketcode}}', '{{result.isuSrtCd}}', 'M')">월봉</button>-->
<!--    <button onclick="get_history('{{result.marketcode}}', '{{result.isuSrtCd}}', 'Y')">연봉</button>-->
<!--</div>-->

<div>
    <div style="padding:20px;">
        <table style="width:100%;">
        <tr style="height:50px">
            <td style="text-align:center;width:50%;" class="buy-btn act" onclick="buy()">매수</td>
            <td style="text-align:center;width:50%;" class="sell-btn" onclick="sell()">매도</td>
        </tr>
    </table>
                <div class="buy">
                <input type="hidden" id="buy_marketcode" name="buy_marketcode" value="{{ result.marketcode }}">
                <input type="hidden" id="buy_issuecode" name="buy_issuecode" value="{{ result.isuSrtCd }}">
                <div class="title_1">현재가</div><input type="text" id="buy_price" name="price" value="{{ result.curPrice}}"/>
                <div class="title_1">주</div><input type="number" id="buy_share" name="buy_share" value=""/>
                <div class="btn" onclick="fn_buy_stock()">매수</div>
                <!--    구매 가능한 주 보이기 / 구매 가능한 주 넘어가면 alert 나오기-->
                </div>

                <div class="sell" style="display:none;">
                <input type="hidden" id="sold_marketcode" name="sold_marketcode" value="{{ result.marketcode }}">
                <input type="hidden" id="sold_issuecode" name="sold_issuecode" value="{{ result.isuSrtCd }}">
                <div class="title_1">현재가</div><input type="text" id="sold_price" name="price" value="{{ result.curPrice}}"/>
                <div class="title_1">주</div><input type="number" id="sold_share" name="sold_share" value=""/>
                <div class="btn red_btn" onclick="fn_sold_stock()">매도</div>
                <!--    판매 가능한 주 보이기/ 판매 가능한 주 넘어가면 alert 나오기-->
                 </div>
</div>
</div>

    <div style="display:none;">
        <div id="stocksector_update_alert">업종분류 결과위치</div>
        <button onclick="fn_get_selectivemaster()">PER, PBR (PBR = PER * ROE)</button>
        <Button onclick="fn_stocksector_update()">업종분류 업데이트</Button>
    </div>



    <!-- result.history : 차트 데이터 -->


<script>
    function sell(){
    $('.buy').hide();
    $('.sell').show();
    $('.buy-btn').removeClass('act');
    $('.sell-btn').addClass('act');
    }
    function buy(){
    $('.sell').hide();
    $('.buy').show();
     $('.sell-btn').removeClass('act');
    $('.buy-btn').addClass('act');
    }
</script>
<script>
    var ctx = document.getElementById("myChart");
var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for r in result.day_history %} '{{r.trdDd}}', {% endfor %}],
        datasets: [{
            label: '# of Votes',
            data: [{% for r in result.day_history %} '{{r.trdPrc}}', {% endfor %}]
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:false
                }
            }]
        },
        plugins: {
            zoom: {
                // Container for pan options
                pan: {
                    // Boolean to enable panning
                    enabled: true,

                    // Panning directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow panning in the y direction
                    mode: 'xy'
                },

                // Container for zoom options
                zoom: {
                    // Boolean to enable zooming
                    enabled: true,

                    // Zooming directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow zooming in the y direction
                    mode: 'xy',
                }
            }
        }
    }
});
  var ctx = document.getElementById("myChart3");
var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for r in result.year_history %} '{{r.trdDd}}', {% endfor %}],
        datasets: [{
            label: '# of Votes',
            data: [{% for r in result.year_historyy %} '{{r.trdPrc}}', {% endfor %}]
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:false
                }
            }]
        },
        plugins: {
            zoom: {
                // Container for pan options
                pan: {
                    // Boolean to enable panning
                    enabled: true,

                    // Panning directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow panning in the y direction
                    mode: 'xy'
                },

                // Container for zoom options
                zoom: {
                    // Boolean to enable zooming
                    enabled: true,

                    // Zooming directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow zooming in the y direction
                    mode: 'xy',
                }
            }
        }
    }
});
  var ctx = document.getElementById("myChart1");
var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for r in result.week_history %} '{{r.trdDd}}', {% endfor %}],
        datasets: [{
            label: '# of Votes',
            data: [{% for r in result.week_history %} '{{r.trdPrc}}', {% endfor %}]
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:false
                }
            }]
        },
        plugins: {
            zoom: {
                // Container for pan options
                pan: {
                    // Boolean to enable panning
                    enabled: true,

                    // Panning directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow panning in the y direction
                    mode: 'xy'
                },

                // Container for zoom options
                zoom: {
                    // Boolean to enable zooming
                    enabled: true,

                    // Zooming directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow zooming in the y direction
                    mode: 'xy',
                }
            }
        }
    }
});
  var ctx = document.getElementById("myChart2");
var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for r in result.month_history %} '{{r.trdDd}}', {% endfor %}],
        datasets: [{
            label: '# of Votes',
            data: [{% for r in result.month_history %} '{{r.trdPrc}}', {% endfor %}]
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:false
                }
            }]
        },
        plugins: {
            zoom: {
                // Container for pan options
                pan: {
                    // Boolean to enable panning
                    enabled: true,

                    // Panning directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow panning in the y direction
                    mode: 'xy'
                },

                // Container for zoom options
                zoom: {
                    // Boolean to enable zooming
                    enabled: true,

                    // Zooming directions. Remove the appropriate direction to disable
                    // Eg. 'y' would only allow zooming in the y direction
                    mode: 'xy',
                }
            }
        }
    }
});
</script>
<script>
    var csrftoken = getCookie('csrftoken');
    function getCookie(cname) {
        var name = cname + "=";
            decodedCookie = decodeURIComponent(document.cookie);
            ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i].trim();
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

<!--    async function get_current_price(marketcode, issuecode, result_position) {-->
<!--        var result_text = document.getElementsByClassName(result_position);-->
<!--            data = { marketcode, issuecode };-->
<!--            result = await fn_koscom(data);-->
<!--        console.log(JSON.stringify(result.result));-->
<!--        if(result.result !== 'False') {-->
<!--            for (i=0; i < result_text.length; i++)-->
<!--                result_text[i].innerHTML = result.result['trdPrc'];-->
<!--        }-->
<!--    }-->

    function fn_koscom(data) {
        var headers = new Headers();
        headers.append('Content-Type', 'application/json');
        headers.append('X-CSRFToken', csrftoken);
        var response = fetch('/current_stock', {
            method: "POST",
            headers: headers,
            body: JSON.stringify(data)
        })
        return response.then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .catch(err => {
            console.log(err);
        })
    }

    async function get_history(marketcode, issuecode, trnsmCycleTpCd) {
        let today = new Date();
        let year = today.getFullYear().toString().padStart(2, '0');
        let month = (today.getMonth() + 1).toString().padStart(2, '0');
        let date = today.getDate().toString().padStart(2, '0');

        let c_trnsmCycleTpCd = 'D'
        if(trnsmCycleTpCd == 'Y')
            c_trnsmCycleTpCd = 'M';
        else
            c_trnsmCycleTpCd = trnsmCycleTpCd;

        let history_result = await fn_koscom_history(marketcode, issuecode, c_trnsmCycleTpCd, year+month+date)
        if(history_result.result && trnsmCycleTpCd == 'Y')
            history_result = cal_year_history(history_result.result)
        console.log(history_result.result)
    }

    function fn_koscom_history(marketcode, issuecode, trnsmCycleTpCd, today) {
        let data = {
            'marketcode': marketcode,
            'issuecode': issuecode,
            'trnsmCycleTpCd': trnsmCycleTpCd,
            'inqStrtDd': '19800101',    //의미없는 최대값
            'inqEndDd': today,          //오늘 날짜
            'reqCnt': '500'             //의미없는 최대값
        }
        headers = new Headers();
        headers.append('Content-Type', 'application/json');
        headers.append('X-CSRFToken', csrftoken);
        let response = fetch('/get_history', {
            method: "POST",
            headers: headers,
            body: JSON.stringify(data)
        })
        return response.then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .catch(err => {
            console.log(err);
        })
    }

    function cal_year_history(result) {
        let temp_year = ''
        let year_trdPrc = new Array();
        let array_num = 0
        for (let num in result) {
            let cur_year = result[num].trdDd.toString().substring(0, 4)
            if (cur_year != temp_year) {
                temp_year = cur_year
                year_trdPrc[array_num++] = result[num]
            }
        }
        return {result: year_trdPrc}
    }

    function fn_buy_stock() {
        var marketcode = document.getElementById('buy_marketcode').value
            issuecode = document.getElementById('buy_issuecode').value
            current_price = document.getElementById('buy_price').value
            share = document.getElementById('buy_share').value

        var headers = new Headers();
        headers.append('Content-Type', 'application/json')
        headers.append('X-CSRFToken', csrftoken)
        var data = { marketcode, issuecode, current_price, share }
        fetch('/buy_stock', {
            method: "POST",
            headers: headers,
            body: JSON.stringify(data)
        })
        .then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .then(json => {
            console.log(json.result);
        })
        .catch(err => {
            console.log(err)
        })
    }

    function fn_sold_stock() {
        var marketcode = document.getElementById('sold_marketcode').value
            issuecode = document.getElementById('sold_issuecode').value
            current_price = document.getElementById('buy_price').value
            share = document.getElementById('sold_share').value

        var headers = new Headers();
        headers.append('Content-Type', 'application/json')
        headers.append('X-CSRFToken', csrftoken)
        var data = { marketcode, issuecode, current_price, share }
        fetch('/sold_stock', {
            method: "POST",
            headers: headers,
            body: JSON.stringify(data)
        })
        .then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .then(json => {
            console.log(json.result);
        })
        .catch(err => {
            console.log(err)
        })
    }

    function fn_get_selectivemaster() {
        var marketcode = document.getElementById('buy_marketcode').value
            issuecode = document.getElementById('buy_issuecode').value

        var headers = new Headers();
        headers.append('Content-Type', 'application/json')
        headers.append('X-CSRFToken', csrftoken)
        var data = { marketcode, issuecode }
        fetch('/get_selectivemaster', {
            method: "POST",
            headers: headers,
            body: JSON.stringify(data)
        })
        .then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .then(json => {
            console.log(json.result);
        })
        .catch(err => {
            console.log(err)
        })
    }

    function fn_currentPrice() {
        var result_text = document.getElementsByName('price');
        for (i=0; i < result_text.length; i++)
            result_text[i].value = document.getElementsByClassName('current_price')[0].innerText;
    }

    // 업종분류 업데이트
    function fn_stocksector_update() {
        var stocksector_update_alert = document.getElementById('stocksector_update_alert');
        stocksector_update_alert.innerText = 'Please wait until the stocksector updating is over';

        var headers = new Headers();
        headers.append('Content-Type', 'application/json')
        headers.append('X-CSRFToken', csrftoken)
        fetch('/stocksector_update', {
            method: "POST",
            headers: headers
        })
        .then(res => {
            if(res.status === 200) return res.json();
            else console.log(res.statusText);
        })
        .then(json => {
            console.log(json.result);
            stocksector_update_alert.innerText = json.result + ' stocksector updating!!!'
        })
        .catch(err => {
            console.log(err);
            stocksector_update_alert.innerText = 'Fail stocksector updating!!!'
        })
    }
</script>
<script>
    $( document ).ready(function() {
      var element = document.getElementById('howup');
      var int = element.innerHTML;
      var number = Number(int);
      if (number > 0) {
      $('#howup').addClass('red');
      $('.percent').addClass('red');
      $('.fa-angle-down').hide();
      $('.fa-minus').hide();
      }
      else if (number === 0 ) {
      $('.fa-angle-down').hide();
      $('.fa-angle-up').hide();
      }
      else {
      $('#howup').addClass('blue');
      $('.percent').addClass('blue');
      $('.fa-angle-up').hide();
      $('.fa-minus').hide();
      }
    });

    function pick(id){
    alert(id);
    }
</script>
<link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>
<script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
<script>
    var swiper = new Swiper('.swiper', {
  scrollbar: {
    el: '.swiper-scrollbar',
  },
});
    function move_page(index){
    swiper.slideTo(index)
    swiper.update();
    }
    function info(issuecode, marketcode) {
        document.getElementById('issuecode').value = issuecode;
        document.getElementById('marketcode').value = marketcode;
        const form = document.getElementById('form');
        form.action="/stock_info"
        form.submit();
    }
    var body_height = document.documentElement.clientHeight - 555;
    $('.swiper-wrapper').height(body_height)
    $('.swiper').height(body_height)
    swiper.update();
</script>
<Style>
    .swiper-scrollbar-drag{
    background:#31bc8a;
    }
    .swiper {
        position: relative;
        width: 100%;
        overflow: hidden;
    }
    .swiper-slide {
        overflow-y: scroll;
    }
    .myChartDiv {
  max-width: 100%;
  max-height: 100%;
}
</Style>
{% endblock %}

